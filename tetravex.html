<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Tetravex</title>
<!-- Ⲧⲉϯⲅⲁⲩⲉⲭ -->
<link rel="stylesheet" type="text/css" href="dojo-release-1.6.0/dijit/themes/tundra/tundra.css" />
<link rel="stylesheet" type="text/css" href="dojo-release-1.6.0/dojo/resources/dojo.css" />
<link rel="stylesheet" type="text/css" href="dojo-release-1.6.0/dojo/resources/dnd.css" />
<script type="text/javascript" src="dojo-release-1.6.0/dojo/dojo.js">
  
</script>
<script type="text/javascript">
  dojo.require("dojox.gfx");
  dojo.require("dojox.gfx.move");

  var container = null, surface = null;
  var params = {
    suface_width : 400,
    suface_height : 200,
    tile_width : 40,
    tile_height : 40
  };

  // even simpler, and easier to programatically create?
  var boardX = [ 20, 70, 120, 210, 260, 310 ];
  var boardY = [ 20, 70, 120 ];

  function initSurface() {
    drawBoard();
    rectangle = surface.createRect(
        {
          x : 0, //what are you - offset, do I need you?
          y : 0,
          width : params.tile_width,
          height : params.tile_height,
          r : 3
        }).setFill(
        "red").setStroke(
        "blue");

    //override onMoving on your object and modify the "shift" object
    //so it never moves a shape outside of a specified boundaries.
    //from here http://dojo-toolkit.33424.n3.nabble.com/gfx-constrainedMoveable-td176539.html
    dojo.extend(
        dojox.gfx.Moveable, {
          onMoving : function(mover, shift) {
            if (mover.shape.matrix) {
              // don't go over the left or right edges - optimize by choosing on x value, 2 is the border??
              if ((shift.dx > 0 && mover.shape.matrix.dx > (params.suface_width - params.tile_width - 2))
                  || (shift.dx < 0 && mover.shape.matrix.dx < 2)) {
                shift.dx = 0;
              }
              // don't go ovet the top or bottom
              if ((shift.dy < 0 && mover.shape.matrix.dy < 2)
                  || (shift.dy > 0 && mover.shape.matrix.dy > (params.suface_height - params.tile_height - 2))) {
                shift.dy = 0;
              }
            }
          }
        });

    // tiles may only rest on a square.
    dojo.subscribe(
        "/gfx/move/stop", this, function moveToNearestSquare(mover) {
          this.mover = mover;

          // need to take into account the middle of the tile, maybe.
          // will also need to call the check if tile is allowed function and return to origin if not.
          function findNearestX(x) {
            console.log("X is " + x);

            var i = 0;
            // less than the first one
            if (x < boardX[i]) {
              return boardX[i];
            }
            // inbetween the middles - do it on the top corner for now
            // this will need some optimising
            for (i = 1; i <= 4; i++) {
              if (x > boardX[i] && x < boardX[i + 1]) {
                return boardX[i];
              }
            }
            // or greater than the last.
            if (x > boardX[5]) {
              return boardX[5];
            }

            // shouldn't get here.
            return 1;
          }
          ;

          function findNearestY(y) {
            console.log("X is " + y);
            return 30;
          }
          ;

          var deltaX = findNearestX(mover.shape.matrix.dx) - mover.shape.matrix.dx;
          var deltaY = findNearestY(mover.shape.matrix.dy) - mover.shape.matrix.dy;

          mover.shape.applyLeftTransform({
            dx : deltaX,
            dy : deltaY
          })

        });

    moveMe = new dojox.gfx.Moveable(
        rectangle);

  }

  function initGfx() {
    container = dojo.byId("gfx_holder");
    surface = dojox.gfx.createSurface(
        container, params.suface_width, params.suface_height);
    surface.whenLoaded(initSurface);
  }
  
  function drawBoard(){
    console.log("draw board");
  }

  dojo.addOnLoad(initGfx);
</script>
</head>
<body>
  <div id="gfx_holder" style="width: 400px; height: 200px; background-color: #E1EFBB;"></div>
</body>
</html>